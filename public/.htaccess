AddDefaultCharset UTF-8
AddType 'application/javascript; charset=UTF-8' .js

<IfModule mod_rewrite.c>
    RewriteEngine On

    ############################################
    # 1. REDIRECT SUBDOMAIN -> DOMAIN CHÍNH
    ############################################
    RewriteCond %{HTTP_HOST} ^(www\.)?xanhworld\.haiphongtech\.vn$ [NC]
    RewriteRule ^(.*)$ https://xanhworld.vn/$1 [L,R=301]

    ############################################
    # 2. FORCE HTTPS
    ############################################
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    ############################################
    # 3. WWW → NON-WWW
    ############################################
    RewriteCond %{HTTP_HOST} ^www\.xanhworld\.vn$ [NC]
    RewriteRule ^ https://xanhworld.vn%{REQUEST_URI} [R=301,L]

    ############################################
    # 4. TẮT MULTIVIEWS
    ############################################
    <IfModule mod_negotiation.c>
    Options -MultiViews -Indexes
    </IfModule>

    ############################################
    # 5. CACHE ẢNH WEBP
    ############################################
    <IfModule mod_headers.c>
        <FilesMatch "\.(webp)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>
    </IfModule>

    ############################################
    # 6. DỌN URL (tránh redirect loop)
    ############################################
    # Loại bỏ dấu // thừa (chỉ redirect 1 lần, tránh loop)
    RewriteCond %{REQUEST_URI} ^(.*)//+(.*)$
    RewriteCond %{REQUEST_URI} !^/clients/assets/ [NC]
    RewriteRule ^ %1/%2 [R=301,L]

    # Loại bỏ trailing slash (trừ thư mục thật)
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteCond %{REQUEST_URI} !^/clients/assets/ [NC]
    RewriteRule ^ %1 [R=301,L]

    # Loại bỏ index.php
    RewriteCond %{THE_REQUEST} \s/index\.php[?\s] [NC]
    RewriteRule ^index\.php$ https://xanhworld.vn/ [R=301,L]

    RewriteCond %{THE_REQUEST} \s/index\.php/([^\s?]*) [NC]
    RewriteRule ^index\.php/(.*)$ https://xanhworld.vn/%1 [R=301,L]

    ############################################
    # 7. EXPIRES HEADER
    ############################################
    <IfModule mod_expires.c>
        ExpiresActive On

        # ======================
        # Images
        # ======================
        ExpiresByType image/jpg  "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/png  "access plus 1 year"
        ExpiresByType image/gif  "access plus 1 year"
        ExpiresByType image/avif "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"

        # ======================
        # Fonts
        # ======================
        ExpiresByType font/woff  "access plus 1 year"
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"

        # ======================
        # CSS & JS
        # ======================
        ExpiresByType text/css "access plus 30 days"
        ExpiresByType application/javascript "access plus 30 days"
        ExpiresByType application/x-javascript "access plus 30 days"
    </IfModule>

    <IfModule mod_headers.c>
        # Images - immutable
        <FilesMatch "\.(jpg|jpeg|png|gif|avif|svg)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>

        # Fonts
        <FilesMatch "\.(woff|woff2)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>

        # CSS & JS
        <FilesMatch "\.(css|js)$">
            Header set Cache-Control "public, max-age=2592000"
        </FilesMatch>
    </IfModule>

    ############################################
    # 8. LARAVEL ROUTE
    ############################################
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Cho phép crawler truy cập tất cả routes (không chặn)
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^ index.php [L]
</IfModule>
